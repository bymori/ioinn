---
title: MongoDb数据库的安装和使用
date: 2021-10-31 18:51:41
permalink: /pages/03cfcb/
categories:
  - JavaScript
  - MongoDb数据库
tags:
  - 
---

## NoSql 介绍

### NoSQL 介绍

NoSQL(NoSQL = Not Only SQL )，意即“不仅仅是 `SQL`”，它指的是非关系型的数据库，是以 `key-value形式存储`，和传统的关系型数据库不一样，`不一定遵循传统数据库的一些基本要求`，比如说遵循 `SQL 标准`、ACID 属性、表结构等等。NoSQL 最早被提出是在 20 世纪 80 年代，在当时更多是强调的是与关系数据库区别对待，`最近这些年被提及的更多是强调协助解决大数据等相关问题`。**NoSQL 在大数据时代有自己的意义。**
<!-- more -->
### NoSQL 这种适合特定场景需求的选项

NoSQL 数据库在以下的这几种情况下比较适用：

1. 数据模型比较简单；
2. 需要灵活性更强的 IT 系统；
3. 对数据库性能要求较高；
4. 不需要高度的数据一致性；
5. 对于给定 key，比较容易映射复杂值的环境。

### NoSQL 发展现状

`国外`： Google 的 BigTable 和 Amazon 的 Dynamo 使用的就是 NoSQL 型数据库。
`国内`：百度、阿里、腾讯、新浪微博、视觉中国、优酷运营数据分析、飞信空间、豆瓣社区等..

## NoSql 和 传统数据库简单对比

非结构型数据库。**没有行、列的概念。用 JSON 来存储数据。集合就相当于“表”，文档就相当于“行”**

![image](https://cdn.jsdelivr.net/gh/bymori/image-PicX@main/blog/image.2f5yr8ace3wg.png)

## MongoDb 介绍

MongoDB 是一个介于关系数据库和非关系数据库之间的产品，`是非关系数据库当中功能最丰富，最像关系数据库的 NoSql 数据库`。他支持的数据结构非常松散，是类似 json 的 bson 格式，因此可以存储比较复杂的数据类型。Mongodb 最大的特点是他**支持的查询语言非常强大**，其语法有点类似于面向对象的查询语言，`几乎可以实现类似关系数据库单表查询的绝大部分功能`，而且还支持对数据建立索引。它的特点是**高性能、易部署、易使用，存储数据非常方便**

## MongoDb 安装

[官网：https://www.mongodb.com/](https://www.mongodb.com/zh-cn)
[手册：https://docs.mongodb.org/manual/](https://docs.mongodb.com/manual/)
[下载：https://www.mongodb.com/download-center/community](https://www.mongodb.com/try/download/community)

### Windows下的安装

#### 下载MongoDB安装包，选择Windows x64版本安装，下载地址：[https://www.mongodb.com/try/download/community](https://www.mongodb.com/try/download/community)

这里选择社区版本

![image](https://cdn.jsdelivr.net/gh/bymori/image-PicX@main/blog/image.1dmg5asgw9og.png)

#### 运行MongoDB安装包并选择自定义安装，设置好安装路径

![image](https://cdn.jsdelivr.net/gh/bymori/image-PicX@main/blog/image.1k4w35se6o1s.png)

#### 配置MongoDB，让MongoDB作为服务运行，并配置好数据目录和日志目录

![image](https://cdn.jsdelivr.net/gh/bymori/image-PicX@main/blog/image.1u8iohktv4zk.png)

#### 取消MongoDB Compass的安装选项（不取消安装极慢），需要可自行安装

![image](https://cdn.jsdelivr.net/gh/bymori/image-PicX@main/blog/image.5t9ozf110540.png)

#### 双击mongo.exe可以运行MongoDB自带客户端，操作MongoDB

![image](https://cdn.jsdelivr.net/gh/bymori/image-PicX@main/blog/image.wflojdxsubk.png)

#### 连接成功后会显示如下信息

![image](https://cdn.jsdelivr.net/gh/bymori/image-PicX@main/blog/image.kpz9ay9jzvk.png)

#### 如果需要移除MongoDB服务，只需使用管理员权限运行cmd工具，并输入如下命令

```bash
sc.exe delete MongoDB
```

### 客户端工具

> MongoDB的客户端工具有很多，上面没安装的MongoDB Compass就是其中之一，另外Navicat 15版本也有MongoDB的管理功能。这里我们使用的是一款免费的客户端工具Robo 3T（以前叫Robomongo）。

- 首先下载客户端工具，下载地址：[robomongo.org/download](https://robomongo.org/download)
  ![image](https://cdn.jsdelivr.net/gh/bymori/image-PicX@main/blog/image.1nkyexvosjj4.png)
- 下载完成后解压，双击robo3t.exe即可使用
  ![image](https://cdn.jsdelivr.net/gh/bymori/image-PicX@main/blog/image.2lbwipc9hbo0.png)
- 之后创建一个到MongoDB的连接
  ![image](https://cdn.jsdelivr.net/gh/bymori/image-PicX@main/blog/image.22ujz80ve9i.png)
- 创建连接成功以后，就可以操作MongoDB了。
  ![image](https://cdn.jsdelivr.net/gh/bymori/image-PicX@main/blog/image.5n5tnqn9m4w0.png)

### 相关概念

> MongoDB是非关系型数据库当中最像关系型数据库的，所以我们通过它与关系型数据库的对比，来了解下它的概念。

| SQL概念     | MongoDB概念 | 解释/说明                           |
| ----------- | ----------- | ----------------------------------- |
| database    | database    | 数据库                              |
| table       | collection  | 数据库表/集合                       |
| row         | document    | 数据记录行/文档                     |
| column      | field       | 数据字段/域                         |
| index       | index       | 索引                                |
| primary key | primary key | 主键,MongoDB自动将_id字段设置为主键 |

## 使用 MongoDb

### 数据库操作

- 创建数据库，使用use命令去创建数据库，当插入第一条数据时会创建数据库，例如创建一个test数据库
  ![image](https://cdn.jsdelivr.net/gh/bymori/image-PicX@main/blog/image.5uve6hv5gfk0.png)
  
  ```bash
  > use test
  switched to db test
  > db.article.insert({name:"MongoDB 教程"})
  WriteResult({ "nInserted" : 1 })
  > show dbs
  admin   0.000GB
  config  0.000GB
  local   0.000GB
  test    0.000GB
  ```

- 删除数据库，使用db对象中的dropDatabase()方法来删除
  ![image](https://cdn.jsdelivr.net/gh/bymori/image-PicX@main/blog/image.2rls2jusgg20.png)
  
  ```bash
  > db.dropDatabase()
  { "dropped" : "test", "ok" : 1 }
  > show dbs
  admin   0.000GB
  config  0.000GB
  local   0.000GB
  ```

### 集合操作

- 创建集合，使用db对象中的createCollection()方法来创建集合，例如创建一个article集合
  ![image](https://cdn.jsdelivr.net/gh/bymori/image-PicX@main/blog/image.7h1mhqzh91s0.png)

  ```bash
  > use test
  switched to db test
  > db.createCollection("article")
  { "ok" : 1 }
  > show collections
  article
  ```

- 删除集合，使用collection对象的drop()方法来删除集合，例如删除一个article集合
  ![image](https://cdn.jsdelivr.net/gh/bymori/image-PicX@main/blog/image.2quzwt3tlog0.png)

  ```bash
  > db.article.drop()
  true
  > show collections
  ```

## 关系型数据库表 （集合）与表（集合）之间的几种关系

### 一对一的关系

> 一个人对应一个唯一的身份证号，即为一对一的关系。

![image](https://cdn.jsdelivr.net/gh/bymori/image-PicX@main/blog/image.36m1v1vb5to0.png)

### 一对多关系

>一个班级对应多名学生，一个学生只能属于一个班级，即为一对多关系

![image](https://cdn.jsdelivr.net/gh/bymori/image-PicX@main/blog/image.1j4k3b6wkdeo.png)
![image](https://cdn.jsdelivr.net/gh/bymori/image-PicX@main/blog/image.4zh82dstfyo0.png)

### 多对多关系

>一个学生可以选多门课程，而同一门课程可以被多个学生选修，彼此的对应关系 即是多对多关系

![image](https://cdn.jsdelivr.net/gh/bymori/image-PicX@main/blog/image.5xci4ygxmvs0.png)

## MongoDB 的高级查询 aggregate 聚合管道

### MongoDB 聚合管道（Aggregation Pipeline）

使用聚合管道可以对集合中的文档进行变换和组合。

**实际项目**：表关联查询、数据的统计。

MongoDB 中使用 `db.COLLECTION_NAME.aggregate([{<stage>},...])` 方法来构建和使用聚合管道。先看下官网给的实例，感受一下聚合管道的用法

![image](https://cdn.jsdelivr.net/gh/bymori/image-PicX@main/blog/image.31xhbug0muu0.png)

### MongoDB Aggregation 管道操作符与表达式

| 管道操作符   | Description                                            |
| :----------- | ------------------------------------------------------ |
| **$project** | **增加、删除、重命名字段**                             |
| **$match**   | **条件匹配。只满足条件的文档才能进入下一阶段**         |
| $limit       | 限制结果的数量                                         |
| $skip        | 跳过文档的数量                                         |
| $sort        | 条件排序                                               |
| $group       | 条件组合结果 统计                                      |
| **$lookup**  | **$lookup 操作符 用以引入其它集合的数据 (表关联查询)** |

#### SQL 和 NoSQL 对比

| SQL        | NoSQL        |
| :--------- | ------------ |
| **WHERE**  | **$match**   |
| GROUP BY   | $group       |
| **HAVING** | **$match**   |
| **SELECT** | **$project** |
| ORDER BY   | $sort        |
| LIMIT      | $limit       |
| SUM()      | $sum         |
| COUNT()    | $sum         |
| **join**   | **$lookup**  |

#### 管道表达式

管道操作符作为“键”,所对应的“值”叫做管道表达式。

例如`{$match:{status:"A"}}`，`$match` 称为管道操作符，而 `status:"A"`称为管道表达式，

是管道操作符的操作数(Operand)。
每个管道表达式是一个文档结构，它是由字段名、字段值、和一些表达式操作符组成的

| 常用表达式操作符 | Description            |
| :--------------- | ---------------------- |
| $addToSet        | 将文档指定字段的值去重 |
| $max             | 文档指定字段的最大值   |
| $min             | 文档指定字段的最小值   |
| $sum             | 文档指定字段求和       |
| $avg             | 文档指定字段求平均     |
| $gt              | 大于给定值             |
| $lt              | 小于给定值             |
| $eq              | 等于给定值             |

### 模拟数据

```bash
db.order.insert({"order_id":"1","uid":10,"trade_no":"111","all_price":100,"all_num":2})
db.order.insert({"order_id":"2","uid":7,"trade_no":"222","all_price":90,"all_num":2})
db.order.insert({"order_id":"3","uid":9,"trade_no":"333","all_price":20,"all_num":6})
db.order_item.insert({"order_id":"1","title":"商品鼠标 1","price":50,num:1})
db.order_item.insert({"order_id":"1","title":"商品键盘 2","price":50,num:1})
db.order_item.insert({"order_id":"1","title":"商品键盘 3","price":0,num:1})
db.order_item.insert({"order_id":"2","title":"牛奶","price":50,num:1})
db.order_item.insert({"order_id":"2","title":"酸奶","price":40,num:1})
db.order_item.insert({"order_id":"3","title":"矿泉水","price":2,num:5})
db.order_item.insert({"order_id":"3","title":"毛巾","price":10,num:1})
```

#### $project

修改文档的结构，可以用来重命名、增加或删除文档中的字段

```bash
db.order.aggregate(
  [{$project:{ trade_no:1, all_price:1 }}]
)
```

![image](https://cdn.jsdelivr.net/gh/bymori/image-PicX@main/blog/image.3vqu5d3qry60.png)

#### $match

用于过滤文档。用法类似于 find() 方法中的参数

```bash
db.order.aggregate([
  {$project:{ trade_no:1, all_price:1 }}, 
  {$match:{"all_price":{$gte:90}}}
])
```

![image](https://cdn.jsdelivr.net/gh/bymori/image-PicX@main/blog/image.6hpkgkb4ot80.png)

#### $limit

限制聚合管道返回的文档数

```bash
db.order.aggregate([
  {$project:{ trade_no:1, all_price:1 }}, 
  {$match:{"all_price":{$gte:90}}}, 
  {$sort:{"all_price":-1}}, 
  {$limit:1}
])
```

![image](https://cdn.jsdelivr.net/gh/bymori/image-PicX@main/blog/image.74efbq6d0l40.png)

#### $skip

跳过指定数量的文档，并返回余下的文档

```bash
db.order.aggregate([
  {$project:{ trade_no:1, all_price:1 }}, 
  {$match:{"all_price":{$gte:90}}}, 
  {$sort:{"all_price":-1}},
  {$skip:1}
])
```

![image](https://cdn.jsdelivr.net/gh/bymori/image-PicX@main/blog/image.7gwp9a5nop80.png)

#### $sort

将集合中的文档进行排序

```bash{4}
db.order.aggregate([
  {$project:{ trade_no:1, all_price:1 }}, 
  {$match:{"all_price":{$gte:90}}}, 
  {$sort:{"all_price":-1}}
])
```

![image](https://cdn.jsdelivr.net/gh/bymori/image-PicX@main/blog/image.29c1g3i2r9c0.png)

#### $group

将集合中的文档进行分组，可用于统计结果。
统计每个订单的订单数量，按照订单号分组

```bash
db.order_item.aggregate([
  {$group: {_id: "$order_id", total: {$sum: "$num"}}}
])
```

![image](https://cdn.jsdelivr.net/gh/bymori/image-PicX@main/blog/image.2598ak27sq2o.png)

#### $lookup

多表关联

```bash{4}
db.order.aggregate([
  {$lookup:
    {
      from: "order_item",
      localField: "order_id", 
      foreignField: "order_id", 
      as: "items"
    }
  }
])
```

![image](https://cdn.jsdelivr.net/gh/bymori/image-PicX@main/blog/image.2cfi1vpldklc.png)

```bash{5}
db.order.aggregate([
  {
    $lookup:
      {
        from: "order_item",
        localField: "order_id", foreignField: "order_id", 
        as: "items"
      }
  }, 
  {$match:{"all_price":{$gte:90}}}
])
```

![image](https://cdn.jsdelivr.net/gh/bymori/image-PicX@main/blog/image.2c3vrz705dhc.png)

```bash{5}
db.order.aggregate([
  {
    $lookup:
      {
        from: "order_item",
        localField: "order_id", 
        foreignField: "order_id", 
        as: "items"
      }
  }, 
  {$project:{ trade_no:1, all_price:1,items:1 }}, 
  {$match:{"all_price":{$gte:90}}}, 
  {$sort:{"all_price":-1}} 
])
```

![image](https://cdn.jsdelivr.net/gh/bymori/image-PicX@main/blog/image.5onafm7l8wg0.png)

## Nodejs调用Mongodb驱动 实现数据的增加 修改 删除

### Nodejs 中使用 Mongodb

Nodejs 操作 mongodb 数据库：[https://www.runoob.com/mongodb/mongodb-tutorial.html](https://www.runoob.com/mongodb/mongodb-tutorial.html)

```bash
npm install mongodb
# or ...
yarn add mongodb
```

### 使用 Nodejs 连接 MongoDb 数据库

```js
const { MongoClient } = require('mongodb');
const url = 'mongodb://127.0.0.1:27017';
// const url = 'mongodb://admin:123456@localhost:27017/'; 有密码连接方式
const dbName = 'test';
const client = new MongoClient(url, { useUnifiedTopology: true });
client.connect((err) => {
  if (err) {
    console.log(err);
    return;
  }
  console.log('数据库连接成功');

  let db = client.db(dbName);
});
```

::: warning
如果数据库开启了权限验证的话需要使用下面方式连接数据库

```bash
const url = 'mongodb://admin:123456@localhost:27017/';
```

**其中**：admin 表示用户名，123456 表示密码
:::

### 查找数据

```js
const { MongoClient } = require('mongodb');
const url = 'mongodb://127.0.0.1:27017';
const dbName = 'test';
const client = new MongoClient(url, { useUnifiedTopology: true });
client.connect((err) => {
  if (err) {
    console.log(err);
    return;
  }
  console.log('数据库连接成功');
  let db = client.db(dbName);

  //1、查找数据
  db.collection('user')
    .find({ age: 13 })
    .toArray((err, data) => {
      if (err) {
        console.log(err);
        return;
      }
      console.log(data);
      //操作数据库完毕以后一定要 关闭数据库连接
      client.close();
    });
});
```

### 增加数据

```bash
  //2、增加数据
  db.collection('user').insertOne(
    { username: 'nodejs操作mongodb', age: 10 },
    (err, result) => {
      if (err) {
        //增加失败
        console.log(err);
        return;
      }
      console.log('增加成功');
      console.log(result);
      //操作数据库完毕以后一定要 关闭数据库连接
      client.close();
    }
  );
```

### 修改数据

```bash
  //3、修改数据
  db.collection('user').updateOne(
    { name: 'zhangsan' },
    { $set: { age: 10 } },
    (err, result) => {
      if (err) {
        //修改失败
        console.log(err);
        return;
      }
      console.log('修改成功');
      console.log(result);
      //操作数据库完毕以后一定要 关闭数据库连接
      client.close();
    }
  );
```

### 删除一条数据

```bash
  //4、删除一条数据
  db.collection('user').deleteOne({ username: 'nodejs' }, (err) => {
    if (err) {
      console.log(err);
      return;
    }
    console.log('删除一条数据成功');
    client.close();
  });
```

### 删除多条数据

```bash
  //5、删除多条数据
  db.collection('user').deleteMany({ username: 'nodejs' }, (err) => {
    if (err) {
      console.log(err);
      return;
    }
    console.log('删除多条数据成功');
    client.close();
  });
```
