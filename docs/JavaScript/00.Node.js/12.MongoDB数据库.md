---
title: MongoDB数据库
date: 2021-11-05 18:21:46
permalink: /pages/778691/
categories:
  - JavaScript
  - js
tags:
  - MongoDB数据库
---
## 数据库概述及环境搭建

### 为什么要使用数据库

- 动态网站中的数据都是存储在数据库中的
- 数据库可以用来持久存储客户端通过表单收集的用户信息
- 数据库软件本身可以对数据进行高效的管理

<!-- more -->

### 什么是数据库

数据库即存储数据的仓库，可以将数据进行有序的分门别类的存储。它是独立于语言之外的软件，可以通过API去操作它。

常见的数据库软件有：MySQL、mongoDB、oracle。
![什么是数据库](https://cdn.jsdelivr.net/gh/bymori/image-PicX@main/img/ppgsm2q0hm-1636107806845.png)

#### MongoDB数据库下载安装

下载地址：[https://www.mongodb.com/download-center/community](https://www.mongodb.com/download-center/community)

#### MongoDB可视化软件

MongoDB可视化操作软件，是使用图形界面操作数据库的一种方式。

![MongoDB可视化软件](https://cdn.jsdelivr.net/gh/bymori/image-PicX@main/img/kozkwsguij-1636107866536.png)

### 数据库相关概念

在一个数据库软件中可以包含多个数据仓库，在每个数据仓库中可以包含多个数据集合，每个数据集合中可以包含多条文档（具体的数据）。

|    术语    | 解释说明                                                     |
| :--------: | ------------------------------------------------------------ |
|  database  | **数据库**，mongoDB数据库软件中可以建立多个数据库            |
| collection | **集合**，一组数据的集合，可以理解为JavaScript中的数组       |
|  document  | **文档**，一条具体的数据，可以理解为JavaScript中的对象       |
|   field    | **字段**，文档中的属性名称，可以理解为JavaScript中的对象属性 |

### Mongoose第三方包

- 使用Node.js操作MongoDB数据库需要依赖Node.js第三方包mongoose
- 使用`npm install mongoose`命令下载

### 启动MongoDB

在命令行工具中运行`net start mongoDB`即可启动MongoDB，否则MongoDB将无法连接。

### 数据库连接

使用mongoose提供的connect方法即可连接数据库。

```js
// 引入mongoose第三方模块 用来操作数据库
const mongoose = require('mongoose');
// 数据库连接
mongoose
  .connect('mongodb://localhost/playground', { useNewUrlParser: true })
  // 连接成功
  .then(() => console.log('数据库连接成功'))
  // 连接失败
  .catch((err) => console.log(err, '数据库连接失败'));
```

### 创建数据库

在MongoDB中`不需要显式创建数据库`，如果正在使用的数据库不存在，`MongoDB会自动创建`。

## MongoDB增删改查操作

### 创建集合

创建集合分为两步，一是`对集合设定规则`，二是`创建集合`，创建mongoose.Schema构造函数的实例即可创建集合。

```js
  // 设定集合规则
 const courseSchema = new mongoose.Schema({
     name: String,
     author: String,
     isPublished: Boolean
 });
  // 创建集合并应用规则
 const Course = mongoose.model('Course', courseSchema); // courses
```

### 创建文档

创建文档实际上就是向集合中插入数据。
分为两步：

1. 创建集合实例。
2. 调用实例对象下的save方法将数据保存到数据库中。

```js
const mongoose = require('mongoose');
mongoose
  .connect('mongodb://localhost/playground', { useNewUrlParser: true })
  .then(() => console.log('数据库连接成功'))
  .catch((err) => console.log(err, '数据库连接失败'));

// 创建集合规则
const courseSchema = new mongoose.Schema({
  name: String,
  author: String,
  isPublished: Boolean,
});

// 使用规则创建集合
// mongoose.model('ModelName', mySchema)
// 1.集合名称
// 2.集合规则
const Course = mongoose.model('Course', courseSchema); // courses

// 创建文档
const course = new Course({
  name: 'node.js基础',
  author: '沫沫',
  isPublished: true,
});
// 将文档插入到数据库中
course.save();
```

```js
// 向集合中插入文档
Course.create(
  { name: 'Javascript', author: '沫沫', isPublished: false },
  (err, result) => {
    console.log(err); // 错误对象
    console.log(result); // 当前插入的文档
  }
);

Course.create({
  name: 'Javascript123',
  author: '沫沫',
  isPublished: false,
}).then((result) => {
  console.log(result);
});
```

#### mongoDB数据库导入数据

```shell
mongoimport –d 数据库名称 –c 集合名称 –file 要导入的数据文件
```

找到mongodb数据库的安装目录，将安装目录下的bin目录放置在环境变量中。

### 查询文档

```js
const mongoose = require('mongoose');
mongoose
  .connect('mongodb://localhost/playground', { useNewUrlParser: true })
  .then(() => console.log('数据库连接成功'))
  .catch((err) => console.log(err, '数据库连接失败'));

// 创建集合规则
const userSchema = new mongoose.Schema({
  name: String,
  age: Number,
  email: String,
  password: String,
  hobbies: [String],
});

// 使用规则创建集合
const User = mongoose.model('User', userSchema);
```

```js
// 查询用户集合中的所有文档
User.find().then((result) => console.log(result));

// 通过_id字段查找文档
User.find({ _id: '5c09f267aeb04b22f8460968' }).then((result) =>
  console.log(result)
);

// findOne方法返回一条文档 默认返回当前集合中的第一条文档
User.findOne({name: '李四'}).then((result) => console.log(result));

// 查询用户集合中年龄字段大于20并且小于40的文档
User.find({ age: { $gt: 20, $lt: 40 } }).then((result) => console.log(result));

// 查询用户集合中hobbies字段值包含足球的文档
User.find({ hobbies: { $in: ['足球'] } }).then((result) => console.log(result));

// 选择要查询的字段
User.find()
  .select('name email -_id')
  .then((result) => console.log(result));

// 根据年龄字段进行升序排列
User.find()
  .sort('age')
  .then((result) => console.log(result));

// 根据年龄字段进行降序排列
User.find()
  .sort('-age')
  .then((result) => console.log(result));

// 查询文档跳过前两条结果 限制显示3条结果
User.find()
  .skip(2)
  .limit(3)
  .then((result) => console.log(result));
```

### 删除文档

```js
const mongoose = require('mongoose');
mongoose
  .connect('mongodb://localhost/playground', { useNewUrlParser: true })
  .then(() => console.log('数据库连接成功'))
  .catch((err) => console.log(err, '数据库连接失败'));

// 创建集合规则
const userSchema = new mongoose.Schema({
  name: String,
  age: Number,
  email: String,
  password: String,
  hobbies: [String],
});

// 使用规则创建集合
const User = mongoose.model('User', userSchema);
```

```js
// 查找到一条文档并且删除
// 返回删除的文档
// 如何查询条件匹配了多个文档 那么将会删除第一个匹配的文档
User.findOneAndDelete({ _id: '5c09f267aeb04b22f8460968' }).then((result) =>
  console.log(result)
);

// 删除多条文档
User.deleteMany({}).then((result) => console.log(result));
```

### 更新文档

```js
const mongoose = require('mongoose');
mongoose
  .connect('mongodb://localhost/playground', { useNewUrlParser: true })
  .then(() => console.log('数据库连接成功'))
  .catch((err) => console.log(err, '数据库连接失败'));

// 创建集合规则
const userSchema = new mongoose.Schema({
  name: String,
  age: Number,
  email: String,
  password: String,
  hobbies: [String],
});

// 使用规则创建集合
const User = mongoose.model('User', userSchema);
```

```js
// 更新集合中的文档 (更新一个)
User.updateOne({ name: '李四' }, { age: 120, name: '李狗蛋' }).then((result) =>
  console.log(result)
;

// 更新集合中的文档 (更新多个)
User.updateMany({}, { age: 300 }).then((result) => console.log(result));
```

### mongoose验证

在创建集合规则时，可以设置当前字段的验证规则，验证失败就则输入插入失败。

- **required**: true 必传字段
- **minlength**：3 字符串最小长度
- **maxlength**: 20 字符串最大长度
- **min**: 2 数值最小为2
- **max**: 100 数值最大为100
- **enum**: ['html', 'css', 'javascript', 'node.js']
- **trim**: true 去除字符串两边的空格
- **validate**: 自定义验证器
- **default**: 默认值

::: warning 获取错误信息
```js
error.errors['字段名称'].message
```
:::

### 集合关联

通常`不同集合的数据之间是有关系的`，例如文章信息和用户信息存储在不同集合中，但文章是某个用户发表的，要查询文章的所有信息包括发表用户，就需要用到集合关联。

- 使用id对集合进行关联
- 使用populate方法进行关联集合查询

![集合关联](https://cdn.jsdelivr.net/gh/bymori/image-PicX@main/img/fifnaytltq-1636202916873.png)

```js
const mongoose = require('mongoose');
mongoose
  .connect('mongodb://localhost/playground', { useNewUrlParser: true })
  .then(() => console.log('数据库连接成功'))
  .catch((err) => console.log(err, '数据库连接失败'));

// 用户集合规则
const userSchema = new mongoose.Schema({
  name: {
    type: String,
    required: true,
  },
});

// 文章集合规则
const postSchema = new mongoose.Schema({
  title: {
    type: String,
  },
  // 使用ID将文章集合和作者集合进行关联
  author: {
    type: mongoose.Schema.Types.ObjectId,
    ref: 'User',
  },
});

// 用户集合
const User = mongoose.model('User', userSchema);
// 文章集合
const Post = mongoose.model('Post', postSchema);

// 创建用户
User.create({ name: 'by_mori' }).then((result) => console.log(result));

// 创建文章
Post.create({ title: '123', author: '6185493b1f72cf8f86bc6cab' }).then(
  (result) => console.log(result)
);

// 查询文章
Post.find()
  .populate('author')
  .then((result) => console.log(result));
```